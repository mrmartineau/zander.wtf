---
import { getCollection } from 'astro:content';
import { ABOUT_ME, JOBS, SIDE_PROJECTS, SITE_FOOTER_ITEMS } from '../consts';
import { fetchLinks } from '../fetching/links';
import {
  accent,
  Box,
  banner,
  bright,
  dim,
  link,
  shortcut,
  span,
  trunc,
} from '../utils/ascii';

// ── Fetch data ────────────────────────────────────────────

const posts = (await getCollection('blog'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 5);

let links: { title: string | null; url: string | null }[] = [];
try {
  links = (await fetchLinks(4)).filter((l) => l.title);
} catch {
  // If links API is unavailable at build time, show empty
}

const projects = SIDE_PROJECTS.slice(0, 4);
const previousJobs = JOBS.previous.map((j) => j.name);

function fmtDate(d: Date) {
  return d.toLocaleDateString('en-GB', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}

// ── Layout constants ──────────────────────────────────────

const W = 72; // total inner width (between outer ║ chars)
const L = 35; // left column width
const R = W - L - 1; // right column width (36) — minus 1 for the middle ║

// ── Build the layout ──────────────────────────────────────

const box = new Box(W);

// Top border
box.top();

// Figlet banner
box.empty();
const art = banner('ZANDER');
box.rows(art.map((line) => '  ' + accent(line)));
box.empty();

// Navigation
const navItems = [
  link('/', '● HOME', 'nav-link active'),
  link('/blog', 'BLOG', 'nav-link'),
  link('/links', 'LINKS', 'nav-link'),
  link('/about', 'ABOUT', 'nav-link'),
  link('/notes', 'NOTES', 'nav-link'),
];

// Color theme swatches
const swatches = [
  `<span class="swatch swatch--green" data-theme="green" title="Green">■</span>`,
  `<span class="swatch swatch--blue" data-theme="blue" title="Blue">■</span>`,
  `<span class="swatch swatch--red" data-theme="red" title="Red">■</span>`,
];

box.row('   ' + navItems.join('   ') + '        ' + swatches.join(' '));

// Intro
box.divider();
box.empty();
box.row('  ' + bright(`Hi! I'm ${accent('ZANDER')}, I make websites`));
box.empty();

// ── About / Blog split ────────────────────────────────────

box.splitDivider('╦', L);
box.splitRow('  ' + bright('ABOUT ME'), '  ' + bright('BLOG'), L);
box.splitRow('  ' + '─'.repeat(L - 4), '  ' + '─'.repeat(R - 4), L);

// About column lines
const aboutLines: string[] = ['  ' + dim(trunc(ABOUT_ME.bio, L - 4)), ''];
if (JOBS.current) {
  aboutLines.push(
    '  ' + bright('Current:') + ' ' + link(JOBS.current.url, JOBS.current.name),
  );
}
if (JOBS.current?.description) {
  aboutLines.push('  ' + dim(JOBS.current.description));
}
aboutLines.push('');
aboutLines.push('  ' + bright('Previous:'));
aboutLines.push('  ' + dim(trunc(previousJobs.slice(0, 5).join(' · '), L - 4)));
aboutLines.push('  ' + dim(trunc(previousJobs.slice(5).join(' · '), L - 4)));
aboutLines.push('');
aboutLines.push('  ' + link('/about', 'More info →'));

// Blog column lines
const blogLines: string[] = [''];
for (let i = 0; i < 5; i++) {
  const post = posts[i];
  if (!post) break;
  const num = String(i + 1);
  blogLines.push(
    '  ' +
      link(
        `/blog/${post.slug}`,
        `[${shortcut(num)}] ${trunc(post.data.title, R - 8)}`,
        '',
        num,
      ),
  );
  blogLines.push('      ' + dim(fmtDate(post.data.date)));
}
blogLines.push('');
blogLines.push('  ' + link('/blog', 'View all articles →'));

box.splitRows(aboutLines, blogLines, L);

// ── Projects / Links split ────────────────────────────────

box.splitDivider('╬', L);
box.splitRow('  ' + bright('SIDE PROJECTS'), '  ' + bright('LINKS'), L);
box.splitRow('  ' + '─'.repeat(L - 4), '  ' + '─'.repeat(R - 4), L);

const projLines: string[] = [];
const linkLines: string[] = ['  ' + dim('Recent bookmarks from Otter:')];

const keys = 'efgh';
for (let i = 0; i < projects.length; i++) {
  const proj = projects[i];
  const key = keys[i];
  const bookmark = links[i];

  projLines.push('');
  projLines.push(
    '  ' +
      link(
        proj.link || '#',
        `[${shortcut(key)}] ${trunc(proj.name, L - 8)}`,
        '',
        key,
      ),
  );
  projLines.push('  ' + dim(trunc(proj.description, L - 4)));
  if (proj.tech) {
    projLines.push('  ' + span('dim tech', trunc(proj.tech, L - 4)));
  }

  linkLines.push('');
  if (bookmark?.title) {
    linkLines.push(
      '  ' + link(bookmark.url || '#', trunc(bookmark.title, R - 4)),
    );
  } else {
    linkLines.push('');
  }
}

projLines.push('');
projLines.push('  ' + link('/about#side-projects', 'View all projects →'));

linkLines.push('');
linkLines.push('  ' + link('/links', 'View all links →'));

box.splitRows(projLines, linkLines, L);

// ── Footer ────────────────────────────────────────────────

box.splitDivider('╩', L);
box.empty();
box.row('  ' + dim('Keyboard shortcuts:'));
box.row(
  '  ' +
    shortcut('[1-5]') +
    ' blog posts  ' +
    shortcut('[e-h]') +
    ' projects  ' +
    shortcut('[/]') +
    ' home  ' +
    shortcut('[q]') +
    ' exit ascii',
);
box.empty();

const footerLinks = SITE_FOOTER_ITEMS.filter((i) => !i.external)
  .map((i) => i.text)
  .join(' · ');
box.row('  ' + dim(footerLinks));
box.row(
  '  ' +
    dim('© 2026 Zander Martineau · This site is always under construction.'),
);
box.empty();
box.row('  ' + span('cursor-blink', '█'));
box.bottom();

const asciiOutput = box.toString();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>zander.wtf // ASCII mode</title>
    <meta name="description" content="ASCII terminal version of zander.wtf" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body>
    <pre class="terminal" id="terminal" set:html={asciiOutput} />

    <div class="status-bar">
      <a href="/">← Exit ASCII mode</a> · Keyboard navigation enabled
    </div>

    <style is:global>
      @font-face {
        font-family: 'Berkeley Mono';
        src: url('/fonts/BerkeleyMono-Regular.woff2') format('woff2');
        font-weight: 400;
        font-display: swap;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        /* Base color in OKLCH — tweak these three values to change the entire palette */
        --base-l: 0.82;
        --base-c: 0.3;
        --base-h: 142;

        /* Derived palette */
        --color-base: oklch(var(--base-l) var(--base-c) var(--base-h));
        --color-muted: oklch(calc(var(--base-l) * 0.55) calc(var(--base-c) * 0.7) var(--base-h));
        --color-bright: oklch(calc(var(--base-l) * 1.1) calc(var(--base-c) * 0.85) var(--base-h));
        --color-accent: oklch(0.8 0.18 75);
        --color-bg: oklch(0.15 0 0);
        --color-glow: oklch(var(--base-l) var(--base-c) var(--base-h) / 0.15);
      }

      body {
        background: var(--color-bg);
        color: var(--color-base);
        font-family: 'Berkeley Mono', 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace;
        font-size: clamp(9px, 1.35vw, 15px);
        line-height: 1.3;
        min-width: 650px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem 1rem;
        overflow-x: auto;
      }

      /* CRT scanline overlay */
      body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.06) 2px,
          rgba(0, 0, 0, 0.06) 4px
        );
        pointer-events: none;
        z-index: 100;
      }

      /* CRT vignette */
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(
          ellipse at center,
          transparent 60%,
          rgba(0, 0, 0, 0.45) 100%
        );
        pointer-events: none;
        z-index: 99;
      }

      .terminal {
        text-shadow: 0 0 8px var(--color-glow), 0 0 2px var(--color-glow);
        max-width: 100%;
        position: relative;
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
      }

      a {
        color: var(--color-bright);
        text-decoration: none;
        cursor: pointer;
        transition: color 0.1s, background 0.1s;
      }

      a:hover,
      a:focus {
        color: var(--color-bg);
        background: var(--color-base);
        outline: none;
      }

      .nav-link {
        color: var(--color-muted);
      }

      .nav-link:hover,
      .nav-link:focus,
      .nav-link.active {
        color: var(--color-bg);
        background: var(--color-base);
      }

      .accent {
        color: var(--color-accent);
        text-shadow: 0 0 10px color-mix(in srgb, var(--color-accent) 25%, transparent);
      }

      .dim {
        color: var(--color-muted);
      }

      .bright {
        color: var(--color-bright);
      }

      .shortcut {
        color: var(--color-accent);
      }

      .tech {
        font-style: italic;
      }

      .swatch {
        cursor: pointer;
        transition: opacity 0.15s;
        opacity: 0.5;
      }

      .swatch:hover {
        opacity: 1;
      }

      .swatch.active {
        opacity: 1;
      }

      .swatch--green { color: oklch(0.82 0.3 142); }
      .swatch--blue  { color: oklch(0.75 0.2 250); }
      .swatch--red   { color: oklch(0.7 0.25 25); }

      .cursor-blink {
        animation: blink 1s step-end infinite;
      }

      @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
      }

      .status-bar {
        color: var(--color-muted);
        font-family: 'Berkeley Mono', 'SF Mono', 'Fira Code', monospace;
        font-size: clamp(9px, 1.35vw, 15px);
        margin-top: 1.5rem;
        text-align: center;
      }

      @media (max-width: 600px) {
        body {
          font-size: 8px;
          padding: 0.5rem 0.25rem;
        }
        .status-bar {
          font-size: 10px;
        }
      }
    </style>

    <script>
      // ── Color theme switching ──────────────────────────────
      const themes: Record<string, { l: number; c: number; h: number }> = {
        green: { l: 0.82, c: 0.3, h: 142 },
        blue:  { l: 0.75, c: 0.2, h: 250 },
        red:   { l: 0.7, c: 0.25, h: 25 },
      };

      function applyTheme(name: string) {
        const t = themes[name];
        if (!t) return;
        const root = document.documentElement;
        root.style.setProperty('--base-l', String(t.l));
        root.style.setProperty('--base-c', String(t.c));
        root.style.setProperty('--base-h', String(t.h));
        localStorage.setItem('ascii-theme', name);

        // Update active swatch
        document.querySelectorAll('.swatch').forEach((el) => {
          el.classList.toggle('active', (el as HTMLElement).dataset.theme === name);
        });
      }

      // Restore saved theme
      const saved = localStorage.getItem('ascii-theme');
      if (saved && themes[saved]) {
        applyTheme(saved);
      } else {
        // Mark green as active by default
        document.querySelector('.swatch--green')?.classList.add('active');
      }

      // Swatch click handlers
      document.querySelectorAll('.swatch').forEach((el) => {
        el.addEventListener('click', () => {
          applyTheme((el as HTMLElement).dataset.theme ?? 'green');
        });
      });

      // ── Keyboard navigation ────────────────────────────────
      document.addEventListener('keydown', (e) => {
        if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
        if (e.metaKey || e.ctrlKey || e.altKey) return;

        const key = e.key.toLowerCase();

        // Shortcut keys for blog posts (1-5) and projects (e-h)
        const el = document.querySelector(`a[data-key="${key}"]`);
        if (el instanceof HTMLAnchorElement) {
          e.preventDefault();
          el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--color-bg');
          el.style.background = getComputedStyle(document.documentElement).getPropertyValue('--color-base');
          setTimeout(() => {
            window.location.href = el.href;
          }, 120);
          return;
        }

        // Navigation shortcuts
        const navMap: Record<string, string> = {
          '/': '/',
          'q': '/',
        };

        if (navMap[key]) {
          e.preventDefault();
          window.location.href = navMap[key];
          return;
        }
      });

      // Power-on flicker effect
      const terminal = document.getElementById('terminal');
      if (terminal) {
        terminal.style.opacity = '0';
        requestAnimationFrame(() => {
          setTimeout(() => {
            terminal.style.transition = 'opacity 0.15s ease-in';
            terminal.style.opacity = '1';
          }, 80);
          setTimeout(() => {
            terminal.style.opacity = '0.92';
            setTimeout(() => {
              terminal.style.opacity = '1';
            }, 60);
          }, 350);
        });
      }
    </script>
  </body>
</html>
